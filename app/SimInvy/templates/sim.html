{% extends "base.html" %}

{% block head %}
<title>GPS Sim Inventory</title>
<link rel="stylesheet" href="{{ url_for('SimInvy.static', filename='css/sim.css') }}" />
<script defer src="{{ url_for('SimInvy.static', filename='js/sim.js') }}"></script>
{% endblock %}

{% block h1 %}
Sim Inventory
{% endblock %}

{% block block_container %}

<div class="status-counters mb-4">
  <div class="counter new-stock">
    <span class="count" id="newStockCount">0</span>
    <span class="label">New Stock</span>
  </div>
  <div class="counter in-use">
    <span class="count" id="inUseCount">0</span>
    <span class="label">In Use</span>
  </div>
  <div class="counter available">
    <span class="count" id="availableCount">0</span>
    <span class="label">Available</span>
  </div>
  <div class="counter scrap">
    <span class="count" id="scrapCount">0</span>
    <span class="label">Scrap</span>
  </div>
  <div class="counter safecustody">
    <span class="count" id="safeCustodyCount">0</span>
    <span class="label">Safe Custody</span>
  </div>
  <div class="counter suspended">
    <span class="count" id="suspendedCount">0</span>
    <span class="label">Suspended</span>
  </div>
</div>

<div class="search-container mb-4">
  <label>Search:</label>
  <input type="text" id="simSearch" placeholder="Search by Mobile, SIM or IMEI..." />

  <div class="filter-container mb-4">
    <select id="statusFilter" onchange="filterSimsByStatus()">
      <option value="All">All Status</option>
      <option value="New Stock">New Stock</option>
      <option value="In Use">In Use</option>
      <option value="Available">Available</option>
      <option value="Scrap">Scrap</option>
      <option value="Safe Custody">Safe Custody</option>
      <option value="Suspended">Suspended</option>
    </select>
  </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
  <button id="manualEntryBtn" class="btn success">Add New SIM</button>
  <button id="uploadBtn" class="btn">Upload</button>
  <button id="downloadExcelBtn" class="btn">Download Excel</button>
</div>

<!-- Manual Entry Modal -->
<div id="manualEntryModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Add New SIM</h2>
    <br>
    <form id="manualForm" action="{{ url_for('SimInvy.manual_entry') }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="form-group">
        <label for="MobileNumber">Mobile Number<span style="size: 12px; color: red;">*</span></label>
        <input type="text" name="MobileNumber" id="MobileNumber" required />
        <div id="mobileError" class="error hidden">Mobile Number must be 10 digits long.</div>
      </div>
      <div class="form-group">
        <label for="SimNumber">SIM Number<span style="size: 12px; color: red;">*</span></label>
        <input type="text" name="SimNumber" id="SimNumber" required />
        <div id="simError" class="error hidden">SIM Number must be 20 digits long.</div>
      </div>
      <div class="form-group">
        <label for="DateIn">Date In<span style="size: 12px; color: red;">*</span></label>
        <input type="date" name="DateIn" id="DateIn" required />
      </div>
      <div class="form-group">
        <label for="DateOut">Date Out</label>
        <input type="date" name="DateOut" id="DateOut" />
      </div>
      <div class="form-group">
        <label for="Vendor">Vendor</label>
        <input type="text" name="Vendor" id="Vendor"/>
      </div>
      <div class="form-group">
        <label for="Status">Status<span style="size: 12px; color: red;">*</span></label>
        <select name="Status" id="Status" required>
          <option value="New Stock" selected>New Stock</option>
          <option value="In Use">In Use</option>
          <option value="Available">Available</option>
          <option value="Scrap">Scrap</option>
          <option value="Safe Custody">Safe Custody</option>
          <option value="Suspended">Suspended</option>
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn success">Submit</button>
        <button type="button" id="cancelBtn" class="btn danger">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal hidden">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Upload SIM Data</h2>
    <br>
    <form id="uploadForm" action="{{ url_for('SimInvy.upload_file') }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="form-group">
        <label for="file">Select Excel File:</label>
        <input type="file" name="file" id="file" accept=".xls,.xlsx" required />
      </div>
      <div class="form-actions">
        <button type="submit" class="btn upload">Upload Excel</button>
        <a href="{{ url_for('SimInvy.download_template') }}" class="btn">Download Template</a>
      </div>
      <div class="preloader"></div>
    </form>
  </div>
</div>

<div id="errorBox" class="error-box hidden"></div>

<div class="sim-table-container">
<table class="sim-table">
  <thead>
    <tr>
      <th>Mobile Number</th>
      <th>SIM Number</th>
      <th>IMEI Number</th>
      <th>Date In</th>
      <th>Date Out</th>
      <th>Vendor</th>
      <th>Status</th>
      <th>Last Edited By</th>
      <th>Last Edited Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="simTable">
    {% for sim in sims %}
    <tr data-id="{{ sim._id }}">
      <td>{{ sim.MobileNumber }}</td>
      <td>{{ sim.SimNumber }}</td>
      <td>{{ sim.IMEI if 'IMEI' in sim else 'N/A' }}</td>
      <td>{{ sim.DateIn }}</td>
      <td>{{ sim.DateOut if sim.DateOut else '' }}</td>
      <td>{{ sim.Vendor }}</td>
      <td>{{ sim.status if sim.status else 'New Stock' }}</td>
      <td>{{ sim.lastEditedBy if 'lastEditedBy' in sim else 'N/A' }}</td>
      <td>{% if 'lastEditedAt' in sim and sim.lastEditedAt %}{{ sim.lastEditedAt.strftime('%d-%m-%Y %I:%M %p') if sim.lastEditedAt.__class__.__name__ == 'datetime' else sim.lastEditedAt }}{% else %}N/A{% endif %}</td>
      <td>
        <button class="icon-btn edit-icon" onclick="editSim('{{ sim._id }}')">✏️</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% endblock %}